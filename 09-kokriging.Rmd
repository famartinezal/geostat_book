---
knit: bookdown::preview_chapter
---

# Estymacje wielozmienne

```{r setup9, echo=FALSE, include=FALSE}
library('knitr')
opts_chunk$set(cache = TRUE, warning=FALSE, message=FALSE) 
library('sp')
wolin_lato_los <- read.csv('data/Wolin_TPZ_p_lato_750losN.csv', na.strings=-999.00)
coordinates(wolin_lato_los) <- ~X+Y
proj4string(wolin_lato_los) <- '+init=epsg:32633'
library('raster')
ras <- raster('data/siatka_raster.tif', level=0)
crs(ras) <- proj4string(wolin_lato_los)
grid <- as(ras, "SpatialGridDataFrame")
```

## Kokriging (prosty i zwykły, SCK i OCK)
### Kokriging (ang. *co-kriging*)
- Kokriging pozwala na wykorzystanie dodatkowej zmiennej (ang. *auxiliary variable*), zwanej inaczej kozmienną (ang. *co-variable*), która może być użyta do prognozwania wartości badanej zmiennej w nieopróbowanej lokalizacji
- Zmienna dodatkowa może być pomierzona w tych samych miejscach, gdzie badana zmienna, jak też w innych niż badana zmienna
- Możliwa jest też sytuacja, gdy zmienna dodatkowa jest pomierzona w dwóch powyższych przypadkach
- Kokriging wymaga, aby obie zmienne były istotnie ze sobą skorelowane
- Najczęściej kokriging jest stosowany w sytuacji, gdy zmienna dodatkowa jest łatwiejsza (tańsza) do pomierzenia niż zmienna główna
- W efekcie, uzyskany zbiór danych zawiera informacje o badanej zmiennej oraz gęściej opróbowane informacje o zmiennej dodatkowej
- Jeżeli informacje o zmiennej dodatkowej są znane dla całego obszaru wówczas bardziej odpowiednią techniką będzie kriging z zewnątrznym trendem (KED)

### Kokriging | Wybór dodatkowej zmiennej
- Wybór zmiennej dodatkowej może opierać się na dwóch kryteriach:
    - Teoretycznym
    - Empirycznym
    
### Kokriging 


```{r kokriging_predict, cache=TRUE}
library('sp')
wolin_lato_los <- read.csv('data/Wolin_TPZ_p_lato_750losN.csv', na.strings=-999.00)
coordinates(wolin_lato_los) <- ~X+Y
proj4string(wolin_lato_los) <- '+init=epsg:32633'

wolin_lato_los_255 <- wolin_lato_los[!is.na(wolin_lato_los$X1999.09.13_TPZ), ]
wolin_lato_los_750 <- wolin_lato_los

library('gstat')
g <- gstat(NULL, id="TPZ1999", form = X1999.09.13_TPZ~1, data = wolin_lato_los_255)
g <- gstat(g, id="TPZ2002", form = X2002.08.20_TPZ~1, data = wolin_lato_los_750)
g

v <- variogram(g)
plot(v)

g <- gstat(g, model=vgm(17, "Sph", 12000, 5), fill.all=TRUE)
g_fit <- fit.lmc(v, g, fit.ranges = FALSE, fit.method=1)
g_fit

plot(v, g_fit)

ck <- predict(g_fit, grid) 

summary(ck)
```

```{r plotsyck1, eval=FALSE}
spplot(ck, "TPZ1999.pred")
spplot(ck, "TPZ1999.var")
```

```{r kokriging_predict_anizotropia, echo=FALSE, cache=TRUE, eval=FALSE}
library('gridExtra')
p1 <- spplot(ck, "TPZ1999.pred", main='Predykcja CK')
p2 <- spplot(ck, "TPZ1999.var", main='Wariancja CK')
grid.arrange(p1, p2, ncol=2)

### Kokriging (anitotropia)
g <- gstat(NULL, id="TPZ1999", form = X1999.09.13_TPZ~1, data = wolin_lato_los_255)
g <- gstat(g, id="TPZ2002", form = X2002.08.20_TPZ~1, data = wolin_lato_los_750)
g

vario_g <- variogram(g, map=TRUE, cutoff=12000, width=800)
plot(vario_g)

vario_g_kier <- variogram(g, alpha = c(60, 105, 150, 195))
plot(vario_g_kier)

g <- gstat(g, model=vgm(17, "Sph", 12000, 5, anis = c(60, .25)), fill.all=TRUE)
g_fit_a <- fit.lmc(vario_g_kier, g, fit.ranges = FALSE, fit.method=1)
g_fit_a
plot(vario_g_kier, g_fit_a)

# ck_a <- predict(g_fit_a, grid) #notworking

# summary(ck_a)
```

```{r plotsyck1a, eval=FALSE}
spplot(ck_a, "TPZ1999.pred")
spplot(ck_a, "TPZ1999.var")
```

```{r plotsyck2a, eval=FALSE}
library('gridExtra')
p1 <- spplot(ck_a, "TPZ1999.pred", main='Predykcja CK - anizotropia')
p2 <- spplot(ck_a, "TPZ1999.var", main='Wariancja CK - anizotropia')
grid.arrange(p1, p2, ncol=2)
```

<!--   
## Kokriging pełny i medianowy, kokriging kolokacyjny, 
## Kokriging na podstawie uproszczonych modeli Markowa I i II
-->

