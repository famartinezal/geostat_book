---
knit: bookdown::preview_chapter
---

# Estymacje wielozmienne {#estymacje-wielozmienne}

```{r}
library('geostatbook')
data(punkty)
data(punkty_ndvi)
data(siatka)
```

```{r setup9, echo=FALSE, include=FALSE}
library('knitr')
opts_chunk$set(cache = TRUE, warning=FALSE, message=FALSE) 
```

```{r, echo=FALSE}
par(mar=c(rep(0, 4)))
```

## Kokriging (prosty i zwykły, SCK i OCK)
### Kokriging (ang. *co-kriging*)
- Kokriging pozwala na wykorzystanie dodatkowej zmiennej (ang. *auxiliary variable*), zwanej inaczej kozmienną (ang. *co-variable*), która może być użyta do prognozwania wartości badanej zmiennej w nieopróbowanej lokalizacji
- Zmienna dodatkowa może być pomierzona w tych samych miejscach, gdzie badana zmienna, jak też w innych niż badana zmienna
- Możliwa jest też sytuacja, gdy zmienna dodatkowa jest pomierzona w dwóch powyższych przypadkach
- Kokriging wymaga, aby obie zmienne były istotnie ze sobą skorelowane
- Najczęściej kokriging jest stosowany w sytuacji, gdy zmienna dodatkowa jest łatwiejsza (tańsza) do pomierzenia niż zmienna główna
- W efekcie, uzyskany zbiór danych zawiera informacje o badanej zmiennej oraz gęściej opróbowane informacje o zmiennej dodatkowej
- Jeżeli informacje o zmiennej dodatkowej są znane dla całego obszaru wówczas bardziej odpowiednią techniką będzie kriging z zewnątrznym trendem (KED)

### Kokriging | Wybór dodatkowej zmiennej
- Wybór zmiennej dodatkowej może opierać się na dwóch kryteriach:
    - Teoretycznym
    - Empirycznym
    
<!--
Kroskowariogramy
Kroskorelogramy
-->

## Krossemiwariogramy
### Krossemiwariogramy
- Krossemiwariogram jest to wariancja różnicy pomiędzy dwiema zmiennymi w dwóch lokalizacjach
- Wyliczając Krossemiwariogram otrzymujemy empiryczne semiwatiogramy dla dwóch badanych zmiennych oraz kroswariogram dla kombinacji dwóch zmiennych
- Krossemiwariogram znajduje swoje zastosowanie w technice zwanej kokrigingiem

### Krossemiwariogramy

```{r, krosssemi}
g <- gstat(NULL, id='SAVI', form = savi~1, data = punkty)
g <- gstat(g, id='NDVI', form = ndvi~1, data = punkty_ndvi)
g
v <- variogram(g)
plot(v)
```

## Modelowanie krossemiwariogramów
### Modelowanie krossemiwariogramów | `fit.lmc`
- Funkcja `fit.lmc` dopasowuje liniowy model koregionalizacji do semiwariogramów wielozmienych 

### Modelowanie krossemiwariogramów

```{r}
g <- gstat(g, model=vgm(0.006, 'Sph', 2000, 0.001), fill.all=TRUE)
g_fit <- fit.lmc(v, g, correct.diagonal = 1.01) #zmienne są bardzo mocno skorelowane - dlatego użyto argumentu correct.diagonal = 1.01
g_fit
plot(v, g_fit)
```

<!--
```{r , eval=FALSE}
# plot(variogram(g, map=TRUE, cutoff=12000, width=800))
plot(variogram(g, alpha = c(60, 105, 150, 195)))
```
-->   

## Kokriging 
### Kokriging 

```{r kokriging_predict, cache=TRUE}
ck <- predict(g_fit, siatka) 
summary(ck)
```

```{r plotsyck1, eval=FALSE}
spplot(ck, 'SAVI.pred')
spplot(ck, 'SAVI.var')
```

```{r kokriging_predicted, echo=FALSE, cache=TRUE, fig.height=8}
library('gridExtra')
p1 <- spplot(ck, "SAVI.pred", main='Predykcja CK')
p2 <- spplot(ck, "SAVI.var", main='Wariancja CK')
grid.arrange(p1, p2, ncol=1)
```

```{r kokriging_predict_anizotropia, echo=FALSE, cache=TRUE, eval=FALSE}
### Kokriging (anitotropia)
g <- gstat(NULL, id="TPZ1999", form = X1999.09.13_TPZ~1, data = punkty_255)
g <- gstat(g, id="TPZ2002", form = X2002.08.20_TPZ~1, data = punkty_750)
g

vario_g <- variogram(g, map=TRUE, cutoff=12000, width=800)
plot(vario_g)

vario_g_kier <- variogram(g, alpha = c(60, 105, 150, 195))
plot(vario_g_kier)

g <- gstat(g, model=vgm(17, "Sph", 12000, 5, anis = c(60, .25)), fill.all=TRUE)
g_fit_a <- fit.lmc(vario_g_kier, g, fit.ranges = FALSE, fit.method=1)
g_fit_a
plot(vario_g_kier, g_fit_a)

# ck_a <- predict(g_fit_a, siatka) #notworking

# summary(ck_a)
```

```{r plotsyck1a, eval=FALSE, echo=FALSE}
spplot(ck_a, "TPZ1999.pred")
spplot(ck_a, "TPZ1999.var")
```

```{r plotsyck2a, eval=FALSE, echo=FALSE, fig.height=8}
library('gridExtra')
p1 <- spplot(ck_a, "TPZ1999.pred", main='Predykcja CK - anizotropia')
p2 <- spplot(ck_a, "TPZ1999.var", main='Wariancja CK - anizotropia')
grid.arrange(p1, p2, ncol=2)
```

<!--   
## Kokriging pełny i medianowy, kokriging kolokacyjny, 
## Kokriging na podstawie uproszczonych modeli Markowa I i II
-->

